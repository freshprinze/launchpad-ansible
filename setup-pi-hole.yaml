- name: Bootstrap PiHole
  hosts: pihole_nodes
  become: true
  roles:
    - role: manage-keepalived
      vars:
        manage_keepalived_state: stopped
    - role: bootstrap-pi
    - role: apt-updates
    - role: manage-keepalived
      vars:
        manage_keepalived_state: started

- name: Copy Mandatory Scripts
  hosts: pihole_nodes
  roles:
    - role: copy-scripts
      vars:
        scripts:
          - '../launchpad-scripts/power/shutdown.sh'
          - '../launchpad-scripts/power/reboot.sh'
        remote_directory: '/home/serveradmin/scripts/'
  tags: scripts

- name: Setup docker
  hosts: pihole_nodes
  become: true
  roles:
    - role: manage-keepalived
      vars:
        manage_keepalived_state: stopped
    - role: setup-docker
    - role: manage-keepalived
      vars:
        manage_keepalived_state: started
  tags: docker

- name: Copy module folders
  hosts: pihole_nodes
  roles:
    - role: copy-module-folders
      vars:
        modules:
          pihole: '../launchpad-docker/pihole'
    - role: update-docker-compose-service
      vars:
        compose_path: '/home/{{ server_admin_user }}/pihole'
  tags: pihole

- name: Setup HA Master
  hosts: pihole_master
  become: true
  roles:
    - role: pihole-keepalived
      vars:
        keepalived_vrrp_role: MASTER
        keepalived_vrrp_priority: 100
        keepalived_vrrp_preempt_delay: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_preempt_delay') }}"
        keepalived_vrrp_password: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_password') }}"
        keepalived_vrrp_vip_ipv4: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_vip') }}"
        keepalived_vrrp_router_id: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_router_id') }}"
        keepalived_unicast_peers: pihole_slaves
  tags:
    - ha
    - master

- name: Setup HA Slaves
  hosts: pihole_slaves
  become: true
  roles:
    - role: pihole-keepalived
      vars:
        keepalived_vrrp_role: BACKUP
        keepalived_vrrp_priority: 1
        keepalived_vrrp_preempt_delay: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_preempt_delay') }}"
        keepalived_vrrp_password: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_password') }}"
        keepalived_vrrp_vip_ipv4: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_vip') }}"
        keepalived_vrrp_router_id: "{{ lookup('ansible.builtin.env', 'pihole_keepalived_router_id') }}"
        keepalived_unicast_peers: pihole_master
  tags:
    - ha
    - slaves
